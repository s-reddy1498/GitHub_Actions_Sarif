name: Build-Scan-Push-Image-scan

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the trivyExploitable branch
on:
  push:
    branches: main

env:
  BuildNumber: ${{ github.run_id }}-${{ github.run_number }}
  ImageName: 'manasiprabhavalkar/python-flask'
  
jobs:
  build:
    runs-on: ubuntu-latest
  # analyze:
  #   name: Analyze (${{ matrix.language }})
  #   # Runner size impacts CodeQL analysis time. To learn more, please see:
  #   #   - https://gh.io/recommended-hardware-resources-for-running-codeql
  #   #   - https://gh.io/supported-runners-and-hardware-resources
  #   #   - https://gh.io/using-larger-runners (GitHub.com only)
  #   # Consider using larger runners or machines with greater resources for possible analysis time improvements.
  #   runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      # required for all workflows
      security-events: write

        # CodeQL supports the following values keywords for 'language': 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build Docker image
      uses: docker/build-push-action@v1.1.0
      with:
        # Username used to log in to a Docker registry. If not set then no login will occur
        username: ${{ secrets.DockerHubUser }}
        # Password or personal access token used to log in to a Docker registry. If not set then no login will occur
        password: ${{ secrets.DockerHubPassword }}
        # Docker repository to tag the image with
        repository: ${{ env.ImageName }}
        # Comma-delimited list of tags. These will be added to the registry/repository to form the image's tags
        tags: 'github-${{ env.BuildNumber }}'
        # Path to the Dockerfile (Default is '{path}/Dockerfile')
        dockerfile: 'Dockerfile'
        # Whether to push the image
        push: false
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'results.sarif'
